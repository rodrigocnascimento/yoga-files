#!/usr/bin/env bash

set -euo pipefail

usage() {
  cat <<'EOF'
Usage:
  yoga-create <template> <project-name>
  yoga-create community <community-template> <project-name>

Templates:
  react | node | next | ts | express

Community:
  Use `yoga-templates list` to see curated names.

Examples:
  yoga-create react my-app
  yoga-create node my-api
  yoga-create community nextjs my-site
EOF
}

template="${1:-}"
name="${2:-}"

if [ -z "$template" ] || [ -z "$name" ] || [ "$template" = "--help" ] || [ "$template" = "-h" ]; then
  usage
  exit 0
fi

case "$template" in
  community)
    comm_name="${2:-}"
    proj_name="${3:-}"
    if [ -z "$comm_name" ] || [ -z "$proj_name" ]; then
      usage
      exit 1
    fi

    YOGA_HOME="${YOGA_HOME:-$HOME/.yoga}"
    index_file="$YOGA_HOME/templates/community/index.yaml"
    if [ ! -f "$index_file" ]; then
      echo "yoga-create: missing community index: $index_file" >&2
      exit 1
    fi

    # Special-cases for known curated templates.
    case "$comm_name" in
      nextjs)
        npx create-next-app@latest "$proj_name" --typescript --tailwind --app
        ;;
      react-vite)
        npm create vite@latest "$proj_name" -- --template react-ts
        ;;
      *)
        echo "yoga-create: unknown community template: $comm_name" >&2
        echo "Run: yoga-templates list" >&2
        exit 1
        ;;
    esac
    ;;
  react)
    npm create vite@latest "$name" -- --template react-ts
    ;;
  node)
    mkdir -p "$name"
    cd "$name"
    npm init -y
    npm install -D typescript @types/node tsx nodemon
    npx tsc --init
    ;;
  next)
    npx create-next-app@latest "$name" --typescript --tailwind --app
    ;;
  ts)
    mkdir -p "$name"
    cd "$name"
    npm init -y
    npm install -D typescript
    npx tsc --init
    ;;
  express)
    mkdir -p "$name"
    cd "$name"
    npm init -y
    npm install express
    npm install -D typescript @types/node @types/express tsx nodemon
    npx tsc --init
    ;;
  *)
    echo "yoga-create: unknown template: $template" >&2
    usage
    exit 1
    ;;
esac
