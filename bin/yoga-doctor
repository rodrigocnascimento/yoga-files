#!/usr/bin/env bash

set -euo pipefail

YOGA_HOME="${YOGA_HOME:-$HOME/.yoga}"

full=0
if [ "${1:-}" = "--full" ]; then
  full=1
fi

if [ ! -f "$YOGA_HOME/core/utils.sh" ]; then
  echo "yoga-doctor: missing: $YOGA_HOME/core/utils.sh" >&2
  exit 1
fi

# shellcheck disable=SC1090
source "$YOGA_HOME/core/utils.sh"

missing_required=0

check_required() {
  local cmd="$1"
  if command -v "$cmd" >/dev/null 2>&1; then
    yoga_terra "required: $cmd"
  else
    yoga_fogo "missing required: $cmd"
    missing_required=1
  fi
}

check_optional() {
  local cmd="$1"
  if command -v "$cmd" >/dev/null 2>&1; then
    yoga_agua "optional: $cmd"
  else
    yoga_sol "missing optional: $cmd"
  fi
}

yoga_espirito "ðŸ§˜ yoga-doctor"
echo "YOGA_HOME=$YOGA_HOME"
echo ""

check_required git
check_required curl
check_required jq
check_required zsh
check_required bash

echo ""

check_optional asdf
check_optional node
check_optional npm
check_optional nvim

echo ""

if [ -n "${OPENAI_API_KEY-}" ]; then
  yoga_agua "OPENAI_API_KEY: set"
else
  yoga_sol "OPENAI_API_KEY: not set (AI commands disabled)"
fi

if [ "$full" -eq 1 ]; then
  echo ""
  yoga_espirito "Full checks"
  if command -v nvim >/dev/null 2>&1; then
    yoga_agua "nvim: headless start"
    nvim --headless +qall >/dev/null 2>&1 || true
  fi
fi

echo ""

if [ "$missing_required" -ne 0 ]; then
  yoga_fogo "Doctor result: FAIL"
  exit 1
fi

yoga_terra "Doctor result: OK"
